<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro da Empresa - 2EHC Treinamentos</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', Arial, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      color: #1e293b;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
      color: white;
      padding: 20px 40px;
      box-shadow: 0 4px 20px rgba(30, 58, 138, 0.3);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 60px;
      height: 60px;
      border-radius: 8px;
    }

    .back-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .back-btn:hover {
      background: rgba(220, 38, 38, 0.3);
    }

    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }

    .form-section {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .form-section h1 {
      color: #1e3a8a;
      margin-bottom: 30px;
      font-size: 32px;
      text-align: center;
      border-bottom: 3px solid #dc2626;
      padding-bottom: 15px;
    }

    .form-section h3 {
      color: #1e3a8a;
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: 600;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    label {
      color: #374151;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }

    input, select, textarea {
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #1e3a8a;
      box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .submit-btn {
      background: linear-gradient(135deg, #1e3a8a, #dc2626);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 20px;
    }

    .submit-btn:hover {
      background: linear-gradient(135deg, #1e40af, #b91c1c);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(30, 58, 138, 0.3);
    }

    .submit-btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .message {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .message.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .message.success {
      background: #f0fdf4;
      color: #16a34a;
      border: 1px solid #bbf7d0;
    }

    .required {
      color: #dc2626;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .header-content {
        flex-direction: column;
        gap: 20px;
      }
      
      .form-section {
        padding: 20px;
      }
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-content">
      <div class="logo-container">
        <img src="logo2ehc.png" alt="Logo 2EHC" class="logo">
        <h1>Cadastro da Empresa</h1>
      </div>
      <a href="index.html" class="back-btn">← Voltar</a>
    </div>
  </div>

  <div class="container">
    <div class="form-section">
      <div id="pedidoAusenteMsg" style="display:none; color:#dc2626; background:#fef2f2; border:1px solid #fecaca; padding:16px; border-radius:8px; margin-bottom:20px; font-weight:500; text-align:center;">Para cadastrar uma empresa, é necessário selecionar cursos e finalizar o pedido no carrinho.</div>
      <form id="empresaForm">
        <h3>Dados da Empresa</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="razaoSocial">Razão Social <span class="required">*</span></label>
            <input type="text" id="razaoSocial" name="razaoSocial" required>
          </div>
          <div class="form-group">
            <label for="cnpj">CNPJ <span class="required">*</span></label>
            <input type="text" id="cnpj" name="cnpj" required placeholder="00.000.000/0000-00">
          </div>
          <div class="form-group">
            <label for="inscricaoEstadual">Inscrição Estadual</label>
            <input type="text" id="inscricaoEstadual" name="inscricaoEstadual">
          </div>
          <div class="form-group">
            <label for="inscricaoMunicipal">Inscrição Municipal</label>
            <input type="text" id="inscricaoMunicipal" name="inscricaoMunicipal">
          </div>
          <div class="form-group">
            <label for="ramoAtividade">Ramo de Atividade <span class="required">*</span></label>
            <input type="text" id="ramoAtividade" name="ramoAtividade" required>
          </div>
          <div class="form-group">
            <label for="numeroFuncionarios">Número de Funcionários <span class="required">*</span></label>
            <select id="numeroFuncionarios" name="numeroFuncionarios" required>
              <option value="">Selecione</option>
              <option value="1-10">1 a 10</option>
              <option value="11-50">11 a 50</option>
              <option value="51-100">51 a 100</option>
              <option value="101-500">101 a 500</option>
              <option value="501-1000">501 a 1000</option>
              <option value="1000+">Mais de 1000</option>
            </select>
          </div>
        </div>

        <h3>Endereço</h3>
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="endereco">Endereço Completo <span class="required">*</span></label>
            <input type="text" id="endereco" name="endereco" required>
          </div>
          <div class="form-group">
            <label for="cidade">Cidade <span class="required">*</span></label>
            <input type="text" id="cidade" name="cidade" required>
          </div>
          <div class="form-group">
            <label for="estado">Estado <span class="required">*</span></label>
            <select id="estado" name="estado" required>
              <option value="">Selecione</option>
              <option value="AC">Acre</option>
              <option value="AL">Alagoas</option>
              <option value="AP">Amapá</option>
              <option value="AM">Amazonas</option>
              <option value="BA">Bahia</option>
              <option value="CE">Ceará</option>
              <option value="DF">Distrito Federal</option>
              <option value="ES">Espírito Santo</option>
              <option value="GO">Goiás</option>
              <option value="MA">Maranhão</option>
              <option value="MT">Mato Grosso</option>
              <option value="MS">Mato Grosso do Sul</option>
              <option value="MG">Minas Gerais</option>
              <option value="PA">Pará</option>
              <option value="PB">Paraíba</option>
              <option value="PR">Paraná</option>
              <option value="PE">Pernambuco</option>
              <option value="PI">Piauí</option>
              <option value="RJ">Rio de Janeiro</option>
              <option value="RN">Rio Grande do Norte</option>
              <option value="RS">Rio Grande do Sul</option>
              <option value="RO">Rondônia</option>
              <option value="RR">Roraima</option>
              <option value="SC">Santa Catarina</option>
              <option value="SP">São Paulo</option>
              <option value="SE">Sergipe</option>
              <option value="TO">Tocantins</option>
            </select>
          </div>
          <div class="form-group">
            <label for="cep">CEP <span class="required">*</span></label>
            <input type="text" id="cep" name="cep" required placeholder="00000-000">
          </div>
        </div>

        <h3>Contato da Empresa</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="telefoneEmpresa">Telefone da Empresa <span class="required">*</span></label>
            <input type="tel" id="telefoneEmpresa" name="telefoneEmpresa" required placeholder="(00) 00000-0000">
          </div>
          <div class="form-group">
            <label for="siteEmpresa">Site da Empresa</label>
            <input type="url" id="siteEmpresa" name="siteEmpresa" placeholder="https://www.empresa.com.br">
          </div>
        </div>

        <h3>Responsável pelo Contrato</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="nomeResponsavel">Nome Completo <span class="required">*</span></label>
            <input type="text" id="nomeResponsavel" name="nomeResponsavel" required>
          </div>
          <div class="form-group">
            <label for="cargoResponsavel">Cargo <span class="required">*</span></label>
            <input type="text" id="cargoResponsavel" name="cargoResponsavel" required>
          </div>
          <div class="form-group">
            <label for="departamento">Departamento</label>
            <input type="text" id="departamento" name="departamento">
          </div>
          <div class="form-group">
            <label for="emailResponsavel">E-mail <span class="required">*</span></label>
            <input type="email" id="emailResponsavel" name="emailResponsavel" required>
          </div>
          <div class="form-group">
            <label for="telefoneResponsavel">Telefone <span class="required">*</span></label>
            <input type="tel" id="telefoneResponsavel" name="telefoneResponsavel" required placeholder="(00) 00000-0000">
          </div>
          <div class="form-group">
            <label for="celularResponsavel">Celular</label>
            <input type="tel" id="celularResponsavel" name="celularResponsavel" placeholder="(00) 00000-0000">
          </div>
        </div>

        <h3>Informações de Pagamento</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="formaPagamento">Forma de Pagamento <span class="required">*</span></label>
            <select id="formaPagamento" name="formaPagamento" required>
              <option value="">Selecione</option>
              <option value="boleto">Boleto Bancário</option>
              <option value="pix">PIX</option>
              <option value="cartao">Cartão de Crédito</option>
              <option value="transferencia">Transferência Bancária</option>
            </select>
          </div>
          <div class="form-group">
            <label for="prazoPagamento">Prazo de Pagamento</label>
            <select id="prazoPagamento" name="prazoPagamento">
              <option value="">Selecione</option>
              <option value="a_vista">À vista</option>
              <option value="30_dias">30 dias</option>
              <option value="60_dias">60 dias</option>
              <option value="90_dias">90 dias</option>
            </select>
          </div>
        </div>

        <div class="form-group full-width">
          <label for="observacoes">Observações</label>
          <textarea id="observacoes" name="observacoes" placeholder="Informações adicionais sobre a empresa ou necessidades específicas..."></textarea>
        </div>

        <h3>Dados de Acesso</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="senha">Senha <span class="required">*</span></label>
            <input type="password" id="senha" name="senha" required>
          </div>
          <div class="form-group">
            <label for="confirmarSenha">Confirmar Senha <span class="required">*</span></label>
            <input type="password" id="confirmarSenha" name="confirmarSenha" required>
          </div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">Cadastrar Empresa</button>
      </form>
    </div>
  </div>

  <script>
    // Obter dados do pedido do localStorage
    const orderData = JSON.parse(localStorage.getItem('currentOrder'));
    const form = document.getElementById('empresaForm');
    const pedidoMsg = document.getElementById('pedidoAusenteMsg');
    if (!orderData) {
      pedidoMsg.style.display = 'block';
      form.querySelectorAll('input, select, textarea, button').forEach(el => el.disabled = true);
    }

    // Funções de validação
    function validarCNPJ(cnpj) {
      cnpj = cnpj.replace(/[^\d]+/g, '');
      if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
      
      let tamanho = cnpj.length - 2;
      let numeros = cnpj.substring(0, tamanho);
      let digitos = cnpj.substring(tamanho);
      let soma = 0;
      let pos = tamanho - 7;
      
      for (let i = tamanho; i >= 1; i--) {
        soma += numeros.charAt(tamanho - i) * pos--;
        if (pos < 2) pos = 9;
      }
      
      let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
      if (resultado !== parseInt(digitos.charAt(0))) return false;
      
      tamanho = tamanho + 1;
      numeros = cnpj.substring(0, tamanho);
      soma = 0;
      pos = tamanho - 7;
      
      for (let i = tamanho; i >= 1; i--) {
        soma += numeros.charAt(tamanho - i) * pos--;
        if (pos < 2) pos = 9;
      }
      
      resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
      if (resultado !== parseInt(digitos.charAt(1))) return false;
      
      return true;
    }

    function validarTelefone(telefone) {
      const telefoneRegex = /^\(\d{2}\)\s?\d{4,5}-\d{4}$/;
      return telefoneRegex.test(telefone);
    }

    function validarCEP(cep) {
      const cepRegex = /^\d{5}-\d{3}$/;
      return cepRegex.test(cep);
    }

    function validarSenha(senha) {
      if (senha.length < 8) return 'Senha deve ter pelo menos 8 caracteres.';
      if (!/[A-Z]/.test(senha)) return 'Senha deve conter pelo menos uma letra maiúscula.';
      if (!/[a-z]/.test(senha)) return 'Senha deve conter pelo menos uma letra minúscula.';
      if (!/\d/.test(senha)) return 'Senha deve conter pelo menos um número.';
      if (!/[!@#$%^&*(),.?":{}|<>\[\]\\/_+=~`';@&-]/.test(senha)) return 'Senha deve conter pelo menos um caractere especial.';
      return null;
    }

    function validarEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email) && email.length <= 254;
    }

    // Máscaras de input
    function applyCNPJMask(value) {
      value = value.replace(/\D/g, '');
      value = value.replace(/^(\d{2})(\d)/, '$1.$2');
      value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
      value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
      value = value.replace(/(\d{4})(\d)/, '$1-$2');
      return value;
    }

    function applyTelefoneMask(value) {
      value = value.replace(/\D/g, '');
      value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
      value = value.replace(/(\d)(\d{4})$/, '$1-$2');
      return value;
    }

    function applyCEPMask(value) {
      value = value.replace(/\D/g, '');
      value = value.replace(/^(\d{5})(\d)/, '$1-$2');
      return value;
    }

    // Aplicar máscaras
    document.getElementById('cnpj').addEventListener('input', (e) => {
      e.target.value = applyCNPJMask(e.target.value);
    });

    document.getElementById('telefoneEmpresa').addEventListener('input', (e) => {
      e.target.value = applyTelefoneMask(e.target.value);
    });

    document.getElementById('telefoneResponsavel').addEventListener('input', (e) => {
      e.target.value = applyTelefoneMask(e.target.value);
    });

    document.getElementById('celularResponsavel').addEventListener('input', (e) => {
      e.target.value = applyTelefoneMask(e.target.value);
    });

    document.getElementById('cep').addEventListener('input', (e) => {
      e.target.value = applyCEPMask(e.target.value);
    });

    // Função para mostrar mensagens
    function showMessage(message, type = 'error') {
      const existingMessage = document.querySelector('.message');
      if (existingMessage) {
        existingMessage.remove();
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      
      const form = document.getElementById('empresaForm');
      form.insertBefore(messageDiv, form.firstChild);
      
      if (type === 'success') {
        setTimeout(() => {
          messageDiv.remove();
        }, 5000);
      }
    }

    // Submissão do formulário
    document.getElementById('empresaForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Cadastrando...';

      try {
        // Validações
        const razaoSocial = document.getElementById('razaoSocial').value.trim();
        const cnpj = document.getElementById('cnpj').value.trim();
        const ramoAtividade = document.getElementById('ramoAtividade').value.trim();
        const numeroFuncionarios = document.getElementById('numeroFuncionarios').value;
        const endereco = document.getElementById('endereco').value.trim();
        const cidade = document.getElementById('cidade').value.trim();
        const estado = document.getElementById('estado').value;
        const cep = document.getElementById('cep').value.trim();
        const telefoneEmpresa = document.getElementById('telefoneEmpresa').value.trim();
        const nomeResponsavel = document.getElementById('nomeResponsavel').value.trim();
        const cargoResponsavel = document.getElementById('cargoResponsavel').value.trim();
        const emailResponsavel = document.getElementById('emailResponsavel').value.trim();
        const telefoneResponsavel = document.getElementById('telefoneResponsavel').value.trim();
        const formaPagamento = document.getElementById('formaPagamento').value;
        const senha = document.getElementById('senha').value;
        const confirmarSenha = document.getElementById('confirmarSenha').value;

        // Validações básicas
        if (razaoSocial.length < 3) {
          showMessage('Razão Social deve ter pelo menos 3 caracteres.');
          return;
        }

        if (!validarCNPJ(cnpj)) {
          showMessage('CNPJ inválido.');
          return;
        }

        if (!ramoAtividade) {
          showMessage('Ramo de atividade é obrigatório.');
          return;
        }

        if (!numeroFuncionarios) {
          showMessage('Número de funcionários é obrigatório.');
          return;
        }

        if (endereco.length < 10) {
          showMessage('Endereço deve ter pelo menos 10 caracteres.');
          return;
        }

        if (cidade.length < 2) {
          showMessage('Cidade deve ter pelo menos 2 caracteres.');
          return;
        }

        if (!estado) {
          showMessage('Estado é obrigatório.');
          return;
        }

        if (!validarCEP(cep)) {
          showMessage('CEP inválido (use formato 00000-000).');
          return;
        }

        if (!validarTelefone(telefoneEmpresa)) {
          showMessage('Telefone da empresa inválido (use formato (xx) xxxxx-xxxx).');
          return;
        }

        if (nomeResponsavel.length < 3) {
          showMessage('Nome do responsável deve ter pelo menos 3 caracteres.');
          return;
        }

        if (cargoResponsavel.length < 2) {
          showMessage('Cargo do responsável deve ter pelo menos 2 caracteres.');
          return;
        }

        if (!validarEmail(emailResponsavel)) {
          showMessage('E-mail inválido.');
          return;
        }

        if (!validarTelefone(telefoneResponsavel)) {
          showMessage('Telefone inválido (use formato (xx) xxxxx-xxxx).');
          return;
        }

        if (!formaPagamento) {
          showMessage('Forma de pagamento é obrigatória.');
          return;
        }

        const senhaError = validarSenha(senha);
        if (senhaError) {
          showMessage(senhaError);
          return;
        }

        if (senha !== confirmarSenha) {
          showMessage('As senhas não coincidem.');
          return;
        }

        // Preparar dados para envio
        const empresaData = {
          razaoSocial,
          cnpj,
          inscricaoEstadual: document.getElementById('inscricaoEstadual').value.trim(),
          inscricaoMunicipal: document.getElementById('inscricaoMunicipal').value.trim(),
          ramoAtividade,
          numeroFuncionarios,
          endereco,
          cidade,
          estado,
          cep,
          telefoneEmpresa,
          siteEmpresa: document.getElementById('siteEmpresa').value.trim(),
          nomeResponsavel,
          cargoResponsavel,
          departamento: document.getElementById('departamento').value.trim(),
          emailResponsavel,
          telefoneResponsavel,
          celularResponsavel: document.getElementById('celularResponsavel').value.trim(),
          formaPagamento,
          prazoPagamento: document.getElementById('prazoPagamento').value,
          observacoes: document.getElementById('observacoes').value.trim(),
          senha,
          confirmarSenha,
          pedido: orderData,
          tipo: 'empresa'
        };

        // Enviar para o backend
        const response = await fetch('http://localhost:3000/api/cadastro-empresa', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(empresaData)
        });

        const result = await response.json();

        if (result.success) {
          showMessage('Empresa cadastrada com sucesso! Redirecionando...', 'success');
          
          // Salvar dados da empresa logada
          localStorage.setItem('empresaLogada', JSON.stringify(result.userData));
          
          // Limpar dados do pedido
          localStorage.removeItem('currentOrder');
          
          // Redirecionar para o dashboard
          setTimeout(() => {
            window.location.href = 'home-empresa.html';
          }, 2000);
        } else {
          showMessage(result.error || 'Erro ao cadastrar empresa.');
        }

      } catch (error) {
        console.error('Erro:', error);
        showMessage('Erro de conexão. Verifique se o servidor está rodando.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Cadastrar Empresa';
      }
    });
  </script>

</body>
</html>